<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade-OS</title>

  <style>
    /* ===============================
       Theme Variables
    =============================== */
    :root {
      --bg: #0f1220;
      --card: #1b1f3b;
      --row: #20255a;
      --border: rgba(255, 255, 255, 0.12);
      --accent: #4f7cff;
      --text: #e6e8ff;
      --muted: #9aa0d1;
      --win: #4f7cff;
      --lose: #f44336;
    }

    /* ===============================
       Base
    =============================== */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    main {
      padding: 16px;
    }

    /* ===============================
       Navigation
    =============================== */
    nav {
      display: flex;
      gap: 8px;
      padding: 8px;
      justify-content: center;
    }

    nav button {
      flex: 1;
      background: linear-gradient(#22286a, #1b1f3b);
      color: var(--text);
      border: none;
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
    }

    nav button.active {
      background: linear-gradient(#4f7cff, #375bd6);
      color: #fff;
    }

    @media (max-width: 600px) {
      nav {
        flex-direction: column;
      }
    }

    /* ===============================
       Card
    =============================== */
    .card {
      background: linear-gradient(180deg, #1b1f3b, #14183a);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    h3 {
      margin: 12px 0 6px;
      font-size: 14px;
      color: var(--muted);
    }

    /* ===============================
       Checklist
    =============================== */
    label {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--row);
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      cursor: pointer;
    }

    label:last-of-type {
      border-bottom: none;
    }

    label input {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    label span {
      flex: 1;
    }

    /* ===============================
       Inputs
    =============================== */
    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: none;
      background: #121533;
      color: var(--text);
    }

    textarea {
      height: 60px;
    }

    /* ===============================
       Result Box
    =============================== */
    .result-box {
      margin: 14px 0;
      padding: 12px;
      text-align: center;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.08);
      font-weight: 600;
    }

    .allow {
      color: var(--win);
    }

    .deny {
      color: var(--lose);
    }

    /* ===============================
       Buttons
    =============================== */
    button.primary {
      margin-top: 8px;
      width: 100%;
      padding: 14px;
      background: linear-gradient(#4f7cff, #375bd6);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 16px;
    }

    /* ===============================
       Trade Rows
    =============================== */
    .trade-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .trade-row-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .trade-row input,
    .trade-row select {
      margin-bottom: 0;
    }

    /* ===============================
       Trade Visuals
    =============================== */
    .result-win {
      color: var(--win);
      font-weight: 600;
    }

    .result-lose {
      color: var(--lose);
      font-weight: 600;
    }

    .side-buy::before {
      content: "â†‘ ";
      color: var(--win);
      font-weight: 700;
    }

    .side-sell::before {
      content: "â†“ ";
      color: var(--lose);
      font-weight: 700;
    }
/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ å‹æ•—è‰² ===== */
.day-win {
  background: rgba(79, 124, 255, 0.35) !important;
}

.day-lose {
  background: rgba(244, 67, 54, 0.35) !important;
}
    
 /* ===== åŸ·è¡Œè¶³ã‚¨ãƒªã‚¢ ç„¡åŠ¹è¡¨ç¤º ===== */
.exe-disabled {
  opacity: 0.35;
  pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ä¸å¯ */
  filter: grayscale(60%);
}

  </style>
</head>

<body>
  <header>Trade-OS</header>

<nav>
  <button id="tab-check" class="active">ğŸ§  ãƒã‚§ãƒƒã‚¯</button>
  <button id="tab-lot">ğŸ§® ãƒ­ãƒƒãƒˆè¨ˆç®—</button>
  <button id="tab-calendar">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
  <button id="tab-stats">ğŸ“Š é›†è¨ˆ</button>
</nav>

  <main>
    <!-- ===============================
         CHECK TAB
    =============================== -->
    <section id="check" class="card">
      <h3>ã‚¹ãƒ†ãƒƒãƒ—â‘ ã€1æ™‚é–“è¶³ã€‘ï¼ˆå…¨ã¦YESï¼‰</h3>
      <label><input type="checkbox" class="h1" /><span>åˆå‹•ãŒå‡ºã¦ã„ã‚‹</span></label>
      <label>
        <input type="radio" name="h1Body" class="h1-normal" />
        <span>åˆå‹•ã§ã€å®Ÿä½“ãŒé•·ã™ããªã„</span>
      </label>
      <label>
        <input type="radio" name="h1Body" class="h1-long" />
        <span>åˆå‹•ã ãŒå®Ÿä½“ãŒã‚„ã‚„é•·ã„</span>
      </label>
      <label><input type="checkbox" class="h1" /><span>MAä¹–é›¢ãŒå¤§ãã™ããªã„</span></label>
      <label><input type="checkbox" class="h1" /><span>é«˜å€¤ãƒ»å®‰å€¤æ´ã¿ã§ãªã„</span></label>
      <label><input type="checkbox" class="h1" /><span>æŠµæŠ—å¸¯ä»˜è¿‘ã§ã¯ãªã„</span></label>
      <label><input type="checkbox" class="h1" /><span>ã€Œã¾ã ä¼¸ã³ãã†ã€ã¨æ„Ÿã˜ã‚‹å½¢</span></label>

      <h3>ã‚¹ãƒ†ãƒƒãƒ—â‘¡ã€4æ™‚é–“è¶³ã€‘</h3>
      <label><input type="checkbox" class="h4" /><span>1Hã¨æ–¹å‘ã®æ•´åˆã‚ã‚Š</span></label>
      <label><input type="checkbox" class="h4" /><span>é ‚ç‚¹ãƒ»åº•ä»˜è¿‘ã§ãªã„</span></label>
      <label><input type="checkbox" class="h4" /><span>TRçš„ã«ä½™åŠ›ã‚ã‚Š</span></label>
      <label><input type="checkbox" class="h4" /><span>å¼·ã„å¦å®šãƒ’ã‚²ãªã—</span></label>
      <label><input type="checkbox" class="h4" /><span>ç›´è¿‘è¶³ãŒã‚³ãƒã§ãªã„</span></label>

<h3>ã‚¹ãƒ†ãƒƒãƒ—â‘¢ã€åŸ·è¡Œè¶³åˆ¤å®šã€‘</h3>

<div id="exeArea">
  <label><input type="radio" name="exe" value="15" /><span>15åˆ†ã‚‚åˆå‹•ã§è‰¯ã„</span></label>
  <label><input type="radio" name="exe" value="60" /><span>15åˆ†ãŒå¾®å¦™ â†’ 1æ™‚é–“åŸ·è¡Œ</span></label>
</div>


      <div id="finalResult" class="result-box">æœªåˆ¤å®š</div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,.15);margin:20px 0;">

<h3>ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²</h3>

<h4 style="margin:8px 0 4px;font-size:13px;color:#9aa0d1">
  æ—¥æ™‚
</h4>

<div class="trade-row">
  <input type="date" id="date" placeholder="æ—¥ä»˜" />
  <input type="time" id="time" placeholder="æ™‚åˆ»" />
</div>

      <!-- 1è¡Œç›®ï¼šBuy/Sell ï¼‹ æˆè¡Œ/æŒ‡å€¤ -->
<div class="trade-row">
  <select id="side">
    <option value="Buy">è²·ã„</option>
    <option value="Sell">å£²ã‚Š</option>
  </select>

  <select id="entryType">
    <option value="">ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ–¹æ³•</option>
    <option value="market">æˆè¡Œ</option>
    <option value="limit">æŒ‡å€¤ï¼ˆæˆ»ã—å¾…ã¡ï¼‰</option>
  </select>
</div>

<!-- 2è¡Œç›®ï¼šå‹æ•— ï¼‹ æ±ºæ¸ˆç†ç”± -->
<div class="trade-row">
  <select id="result">
    <option value="win">å‹ã¡</option>
    <option value="lose">è² ã‘</option>
  </select>

  <select id="exitReason">
    <option value="">æ±ºæ¸ˆç†ç”±</option>
    <option value="TP">TPåˆ°é”</option>
    <option value="SL">SLåˆ°é”</option>
    <option value="TIME">æ™‚é–“åˆ‡ã‚Š</option>
  </select>
</div>


      <input type="number" id="lot" placeholder="ãƒ­ãƒƒãƒˆæ•°" />
      <input type="number" id="amount" placeholder="æç›Šï¼ˆå††ï¼‰" />
      <input type="number" id="pips" placeholder="pipsï¼ˆè‡ªå‹•ï¼‰" disabled />
      <textarea id="comment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>

      <input type="file" id="tradeImage" accept="image/*" />
      <img
        id="previewImage"
        style="display: none; max-width: 100%; border-radius: 8px; margin-bottom: 10px"
      />

      <button class="primary" onclick="saveTrade()">ä¿å­˜</button>
    </section>

    <!-- ===============================
     LOT CALC TAB
    =============================== -->
    <section id="lot-calc" class="card" style="display:none">
      <h3>ãƒ­ãƒƒãƒˆè¨ˆç®—</h3>

      <input type="number" id="margin" placeholder="è¨¼æ‹ é‡‘ï¼ˆå††ï¼‰">
      <input type="number" id="riskPercent" placeholder="æå¤±è¨±å®¹ç‡ï¼ˆ%ï¼‰">
      <input type="number" id="stopPips" placeholder="æåˆ‡å¹…ï¼ˆpipsï¼‰">

      <div class="result-box allow" id="lotResult">
        ãƒ­ãƒƒãƒˆï¼š-
      </div>

      <button class="primary" onclick="calcLot()">è¨ˆç®—ã™ã‚‹</button>
    </section>

    
    <!-- ===============================
         CALENDAR TAB
    =============================== -->
    <section id="calendar" class="card" style="display: none">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px"
      >
        <button onclick="changeMonth(-1)">â†</button>
        <div id="currentMonth"></div>
        <button onclick="changeMonth(1)">â†’</button>
      </div>

      <button style="margin-bottom: 12px" onclick="cleanupImagesForCurrentMonth()">
        ğŸ§¹ è¡¨ç¤ºä¸­ã®æœˆã‚ˆã‚Šå‰ã®ç”»åƒã‚’å‰Šé™¤
      </button>

      <div id="imageUsage" style="margin-bottom: 10px; font-size: 13px; color: #9aa0d1">
        ç”»åƒä½¿ç”¨é‡ï¼šè¨ˆç®—ä¸­â€¦
      </div>

      <div id="monthTotal" style="margin-bottom: 10px; font-weight: 600"></div>
      <div
        id="calendarGrid"
        style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px"
      ></div>
      <div id="dayDetail" style="margin-top: 14px"></div>
    </section>

    <!-- ===============================
         STATS TAB
    =============================== -->
    <section id="stats" class="card" style="display: none">
      <h3>è¡¨ç¤ºæœŸé–“</h3>
       <select id="statsMonth"></select>
       <button class="primary" style="margin:8px 0"
        onclick="exportCSV()">
       ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
       </button>
      <input  type="file"  id="csvImport"  accept=".csv"  style="margin:8px 0"/>
       <button class="primary" style="margin-bottom:12px" onclick="importCSV()" >
       ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå¾©å…ƒï¼‰
       </button>

       <div id="statsContent"></div>
       <canvas id="equityChart" height="160"></canvas>
    </section>

  </main>

<script>
/* =========================================================
   IndexedDB åˆæœŸåŒ–
========================================================= */
let imgDB;
let imgDBReady = false;
let editingTradeId = null;
  
const dbReq = indexedDB.open('tradeImageDB', 1);

dbReq.onupgradeneeded = (e) => {
  e.target.result.createObjectStore('images', { keyPath: 'id' });
};

dbReq.onsuccess = (e) => {
  imgDB = e.target.result;
  imgDBReady = true;
};



/* =========================================================
   ãƒ‡ãƒ¼ã‚¿ & DOMå‚ç…§
========================================================= */
const trades = JSON.parse(localStorage.getItem('trades') || '[]');

const date         = document.getElementById('date');
const time         = document.getElementById('time');
const side         = document.getElementById('side');
const result       = document.getElementById('result');
const exitReasonEl = document.getElementById('exitReason');
const entryTypeEl = document.getElementById('entryType');
const lotEl        = document.getElementById('lot');
const amountEl     = document.getElementById('amount');
const pipsEl       = document.getElementById('pips');
const comment      = document.getElementById('comment');
const tradeImage   = document.getElementById('tradeImage');
const previewImage = document.getElementById('previewImage');

document
  .querySelectorAll('input[type=checkbox], input[type=radio]')
  .forEach((i) => (i.onchange = judge));


/* =========================================================
   ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ & åœ§ç¸®
========================================================= */
let imageData = null;

tradeImage.addEventListener('change', () => {
  const file = tradeImage.files[0];
  if (!file) return;

  const img = new Image();

  img.onload = () => {
    const MAX_W = 900;
    const scale = Math.min(1, MAX_W / img.width);

    const canvas = document.createElement('canvas');
    canvas.width  = img.width  * scale;
    canvas.height = img.height * scale;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(
      (blob) => {
        imageData = blob;
        previewImage.src = URL.createObjectURL(blob);
        previewImage.style.display = 'block';
      },
      'image/jpeg',
      0.7
    );
  };

  img.src = URL.createObjectURL(file);
});


/* =========================================================
   ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆ¤å®š
========================================================= */
function judge() {
  if (editingTradeId) return;
  const h1Base = [...document.querySelectorAll('.h1')]
    .filter(c => !c.classList.contains('h1-normal') && !c.classList.contains('h1-long'))
    .every(c => c.checked);

  const h1Normal = document.querySelector('.h1-normal')?.checked;
  const h1Long   = document.querySelector('.h1-long')?.checked;

  const h4  = [...document.querySelectorAll('.h4')].every(c => c.checked);
  const exe = document.querySelector('input[name="exe"]:checked');
  const box = document.getElementById('finalResult');

// --- 1æ™‚é–“è¶³NG ---
if (!h1Base) {
  document
    .querySelectorAll('input[name="exe"]')
    .forEach(r => r.disabled = false);

  document.getElementById('exeArea').classList.remove('exe-disabled');

  box.textContent = 'âŒ è¦‹é€ã‚Šï¼š1æ™‚é–“è¶³ã®åŸºæœ¬æ¡ä»¶æœªé”';
  box.className = 'result-box deny';
  entryTypeEl.value = '';
  return;
}

// --- ä¼¸ã³ãã‚Š ---
if (!h1Normal && !h1Long) {
  document.getElementById('exeArea').classList.remove('exe-disabled');

  box.textContent = 'âŒ è¦‹é€ã‚Šï¼š1æ™‚é–“è¶³ãŒä¼¸ã³ãã£ã¦ã„ã‚‹';
  box.className = 'result-box deny';
  entryTypeEl.value = '';
  return;
}

// --- 4æ™‚é–“å¦å®š ---
if (!h4) {
  document
    .querySelectorAll('input[name="exe"]')
    .forEach(r => r.disabled = false);

  document.getElementById('exeArea').classList.remove('exe-disabled');

  box.textContent = 'âŒ è¦‹é€ã‚Šï¼š4æ™‚é–“è¶³ãŒå¦å®š';
  box.className = 'result-box deny';
  entryTypeEl.value = '';
  return;
}

// ===== Bãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆåŸ·è¡Œè¶³ã¯1æ™‚é–“å›ºå®šï¼‰=====
if (h1Long) {
  entryTypeEl.value = 'limit';

  document
    .querySelectorAll('input[name="exe"]')
    .forEach(r => {
      r.checked = false;  
      r.disabled = true;
    });

  // â˜… ã“ã‚Œã‚’è¿½åŠ  â˜…
  document.getElementById('exeArea').classList.add('exe-disabled');

  box.textContent =
    'ğŸŸ¡ Bãƒ‘ã‚¿ãƒ¼ãƒ³ï½œ1æ™‚é–“è¶³ æŒ‡å€¤ï¼ˆæˆ»ã—å¾…ã¡ï¼‰';
  box.className = 'result-box allow';
  return;
}


// --- åŸ·è¡Œè¶³æœªé¸æŠï¼ˆAãƒ‘ã‚¿ãƒ¼ãƒ³å°‚ç”¨ï¼‰ ---
document
  .querySelectorAll('input[name="exe"]')
  .forEach(r => r.disabled = false);

if (!exe) {
  box.textContent = 'âš  åŸ·è¡Œè¶³æœªé¸æŠ';
  entryTypeEl.value = '';
  return;
}


// ===== Aãƒ‘ã‚¿ãƒ¼ãƒ³ =====
entryTypeEl.value = 'market';
const exeLabel = exe.value === '60' ? '1æ™‚é–“è¶³' : '15åˆ†è¶³';

box.textContent =
  `âœ… Aãƒ‘ã‚¿ãƒ¼ãƒ³ï½œæˆè¡Œï½œåŸ·è¡Œè¶³ï¼š${exeLabel}`;
box.className = 'result-box allow';
}

/* =========================================================
   ç”»åƒä¿å­˜
========================================================= */
function saveImageToDB(blob) {
  return new Promise((resolve) => {
    const id = 'img_' + Date.now();
    const tx = imgDB.transaction('images', 'readwrite');
    tx.objectStore('images').put({ id, blob });
    tx.oncomplete = () => resolve(id);
  });
}


/* =========================================================
   ãƒˆãƒ¬ãƒ¼ãƒ‰ä¿å­˜
========================================================= */
async function saveTrade() {
  if (!imgDB) {
    alert('ç”»åƒDBã®æº–å‚™ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„');
    return;
  }

  if (!date.value) {
    alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  if (!exitReasonEl.value) {
    alert('æ±ºæ¸ˆç†ç”±ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  if (result.value === 'win' && exitReasonEl.value === 'SL') {
    alert('å‹ã¡ã§SLåˆ°é”ã¯é¸æŠã§ãã¾ã›ã‚“');
    return;
  }

  const lot  = Number(lotEl.value);
  const amt  = Number(amountEl.value);
  if (!lot || !amt) {
  alert('ãƒ­ãƒƒãƒˆã¨æç›Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  return;
  }
  const pips = amt / (lot * 1000);
  pipsEl.value = pips.toFixed(1);

  let imageId = null;
  if (imageData) {
    imageId = await saveImageToDB(imageData);
  }

 const tradeData = {
  id: editingTradeId || ('trade_' + Date.now()),
  date: date.value,
  time: time.value,
  side: side.value,
  result: result.value,
  entryType: entryTypeEl.value,
  lot,
  amount: amt,
  pips,
  comment: comment.value,
  exitReason: exitReasonEl.value,
  imageId: imageId ?? trades.find(t => t.id === editingTradeId)?.imageId ?? null
};

if (editingTradeId) {
  // ===== ç·¨é›†ä¿å­˜ =====
  const index = trades.findIndex(t => t.id === editingTradeId);
  if (index !== -1) {
    trades[index] = tradeData;
  }
  editingTradeId = null; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰è§£é™¤
} else {
  // ===== æ–°è¦ä¿å­˜ =====
  trades.push(tradeData);
}


  localStorage.setItem('trades', JSON.stringify(trades));

  tradeImage.value = '';
  previewImage.style.display = 'none';
  imageData = null;

  alert('ä¿å­˜ã—ã¾ã—ãŸ');
  editingTradeId = null;
  document.querySelector('button.primary').textContent = 'ä¿å­˜';
}


/* =========================================================
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
========================================================= */
let current = new Date();

function changeMonth(diff) {
  current.setMonth(current.getMonth() + diff);
  renderCalendar();
}

function renderCalendar() {
  const y = current.getFullYear();
  const m = current.getMonth();

  document.getElementById('currentMonth').textContent = `${y}å¹´ ${m + 1}æœˆ`;

  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';

  let monthSum = 0;
  const days = new Date(y, m + 1, 0).getDate();

  for (let d = 1; d <= days; d++) {
    const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const dayTrades = trades.filter((t) => t.date === dateStr);
    const hasImage = dayTrades.some(t => t.imageId);
    const total = dayTrades.reduce((a, b) => a + b.amount, 0);

    monthSum += total;

    const cell = document.createElement('div');
    cell.style.padding = '6px';
    cell.style.borderRadius = '8px';
    cell.style.background = 'rgba(255,255,255,.05)';
    cell.style.cursor = 'pointer';

if (total > 0) {
  cell.classList.add('day-win');
} else if (total < 0) {
  cell.classList.add('day-lose');
}

    
cell.innerHTML = `
  <div style="display:flex;justify-content:space-between;align-items:center">
    <span>${d}</span>
    ${hasImage ? '<span style="font-size:14px">ğŸ“·</span>' : ''}
  </div>
  <div style="font-size:12px">${total || ''}</div>
`;

    cell.onclick = () => showDayDetail(dateStr);

    grid.appendChild(cell);
  }

  document.getElementById('monthTotal').textContent =
    `æœˆåˆè¨ˆï¼š${monthSum.toLocaleString()} å††`;
}


/* =========================================================
   æ—¥åˆ¥è©³ç´°
========================================================= */
function showDayDetail(date) {
  const box = document.getElementById('dayDetail');
  const list = trades.filter((t) => t.date === date);

  if (!list.length) {
    box.innerHTML = '';
    return;
  }

  box.innerHTML =
    `<h4>${date} å†…è¨³</h4>` +
    list
      .map(
        (t, i) => `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span>
            ${t.time} ${t.side} ${t.amount}
            [${t.entryType === 'limit' ? 'æŒ‡å€¤' : 'æˆè¡Œ'}]
            (${t.exitReason || 'ç†ç”±ä¸æ˜'})
          </span>
          <span>

       ${t.imageId
  ? `<a
       href="javascript:void(0)"
       onclick="openDBImage('${t.imageId}')"
       style="
         color:#9aa0d1;
         text-decoration:underline;
         font-size:13px;
         cursor:pointer;
       "
     >
       ğŸ“· ç”»åƒå‚ç…§
     </a>`
  : ''
}


            <button onclick="editTrade('${t.id}')">ç·¨é›†</button>
            <button onclick="deleteTrade('${t.id}')">å‰Šé™¤</button>
          </span>
        </div>
      `
      )
      .join('');

}

  function editTrade(id) {
  const t = trades.find(tr => tr.id === id);
  if (!t) return;

  editingTradeId = id;

  // ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
  date.value = t.date;
  time.value = t.time;
  side.value = t.side;
  result.value = t.result;
  entryTypeEl.value = t.entryType;
  lotEl.value = t.lot;
  amountEl.value = t.amount;
  pipsEl.value = t.pips;
  comment.value = t.comment;
  exitReasonEl.value = t.exitReason;

  updateTradeVisual();

  document.querySelector('button.primary').textContent = 'æ›´æ–°';
}

/* =========================================================
   ãƒˆãƒ¬ãƒ¼ãƒ‰å‰Šé™¤
========================================================= */
function deleteTrade(id) {
  const i = trades.findIndex(t => t.id === id);
  if (i === -1) return;

  const trade = trades[i];

  if (trade.imageId) {
    const tx = imgDB.transaction('images', 'readwrite');
    tx.objectStore('images').delete(trade.imageId);
  }

  trades.splice(i, 1);
  localStorage.setItem('trades', JSON.stringify(trades));

  renderCalendar();
  showDayDetail(trade.date);
  updateImageUsage();
}


/* =========================================================
   è¦‹ãŸç›®è‡ªå‹•åæ˜ 
========================================================= */
function updateTradeVisual() {
  side.classList.remove('side-buy', 'side-sell');
  result.classList.remove('result-win', 'result-lose');

  if (side.value === 'Buy')  side.classList.add('side-buy');
  if (side.value === 'Sell') side.classList.add('side-sell');
  if (result.value === 'win')  result.classList.add('result-win');
  if (result.value === 'lose') result.classList.add('result-lose');
}

updateTradeVisual();
side.addEventListener('change', updateTradeVisual);
result.addEventListener('change', updateTradeVisual);

result.addEventListener('change', () => {
  [...exitReasonEl.options].forEach((opt) => {
    opt.disabled = result.value === 'win' && opt.value === 'SL';
  });
});


/* =========================================================
   ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
========================================================= */
function switchTab(tabId) {
  ['check', 'calendar', 'stats', 'lot-calc'].forEach((id) => {
    document.getElementById(id).style.display = 'none';
  });

  document.getElementById(tabId).style.display = 'block';

  document.querySelectorAll('nav button').forEach((b) =>
    b.classList.remove('active')
  );

const map = {
  check: 'tab-check',
  calendar: 'tab-calendar',
  stats: 'tab-stats',
  'lot-calc': 'tab-lot',
};

  document.getElementById(map[tabId]).classList.add('active');

  if (tabId === 'calendar') {
    renderCalendar();
    updateImageUsage();
  }

  if (tabId === 'stats') {
    buildMonthSelector();
    renderStats('all');
  }
}

document.getElementById('tab-check').onclick    = () => switchTab('check');
document.getElementById('tab-calendar').onclick = () => switchTab('calendar');
document.getElementById('tab-stats').onclick    = () => switchTab('stats');
document.getElementById('tab-lot').onclick = () => switchTab('lot-calc');

/* =========================================================
   é›†è¨ˆ
========================================================= */
function renderStats(month = 'all') {
  const box = document.getElementById('statsContent');

  const filtered =
    month === 'all'
      ? trades
      : trades.filter(t => t.date?.startsWith(month));

  if (!filtered.length) {
    box.innerHTML = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
    drawEquityChart([]);
    return;
  }

  const wins  = filtered.filter(t => t.amount > 0);
  const loses = filtered.filter(t => t.amount < 0);

  const total = filtered.length;
  const winRate = ((wins.length / total) * 100).toFixed(1);

  const totalWin  = wins.reduce((a,b)=>a+b.amount,0);
  const totalLose = Math.abs(loses.reduce((a,b)=>a+b.amount,0));

  const avgWin  = wins.length  ? totalWin / wins.length  : 0;
  const avgLose = loses.length ? totalLose / loses.length : 0;

  const rr = avgLose ? (avgWin / avgLose).toFixed(2) : '-';
  const pf = totalLose ? (totalWin / totalLose).toFixed(2) : '-';

  let peak = 0, equity = 0, maxDD = 0;
  filtered.forEach(t => {
    equity += t.amount;
    peak = Math.max(peak, equity);
    maxDD = Math.min(maxDD, equity - peak);
  });

  box.innerHTML = `
    å‹ç‡ï¼š${winRate}%<br>
    å‹æ•—æ•°ï¼š${wins.length}å‹ / ${loses.length}æ•—<br>
    RRï¼š${rr}<br>
    PFï¼š${pf}<br>
    æœ€å¤§DDï¼š${maxDD.toLocaleString()} å††
  `;

  drawEquityChart(filtered);
}

  
function buildMonthSelector() {
  const sel = document.getElementById('statsMonth');
  sel.innerHTML = '';

  // å…¨æœŸé–“
  const optAll = document.createElement('option');
  optAll.value = 'all';
  optAll.textContent = 'å…¨æœŸé–“';
  sel.appendChild(optAll);

  // æœˆä¸€è¦§ï¼ˆé‡è¤‡ãªã—ï¼‰
  const months = [...new Set(
    trades
      .filter(t => t.date)
      .map(t => t.date.slice(0, 7))
  )].sort().reverse();

  months.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    sel.appendChild(opt);
  });

  sel.onchange = () => renderStats(sel.value);
}

function exportCSV() {
  const sel = document.getElementById('statsMonth');
  const month = sel?.value || 'all';

  const target =
    month === 'all'
      ? trades
      : trades.filter(t => t.date?.startsWith(month));

  if (!target.length) {
    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  const header = [
    'æ—¥ä»˜',
    'æ™‚åˆ»',
    'å£²è²·',
    'ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ–¹æ³•',
    'å‹æ•—',
    'æ±ºæ¸ˆç†ç”±',
    'ãƒ­ãƒƒãƒˆ',
    'æç›Š',
    'pips',
    'ã‚³ãƒ¡ãƒ³ãƒˆ'
  ];

  const rows = target.map(t => [
    t.date,
    t.time,
    t.side,
    t.entryType === 'limit' ? 'æŒ‡å€¤' : 'æˆè¡Œ',
    t.result === 'win' ? 'å‹ã¡' : 'è² ã‘',
    t.exitReason,
    t.lot,
    t.amount,
    t.pips,
    (t.comment || '').replace(/\n/g, ' ')
  ]);

  const csv =
    '\uFEFF' + // BOMï¼ˆExcelå¯¾ç­–ï¼‰
    [header, ...rows]
      .map(r => r.map(v => `"${v ?? ''}"`).join(','))
      .join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download =
    month === 'all'
      ? 'trade_backup_all.csv'
      : `trade_backup_${month}.csv`;

  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function importCSV() {
  const fileInput = document.getElementById('csvImport');
  const file = fileInput.files[0];

  if (!file) {
    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }

  if (!confirm(
    'CSVã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒã—ã¾ã™ã€‚\n' +
    'æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã€Œè¿½åŠ ã€ã•ã‚Œã¾ã™ã€‚\n\n' +
    'ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
  )) return;

  const reader = new FileReader();

  reader.onload = () => {
    const text = reader.result;
    const lines = text
      .replace(/\uFEFF/g, '') // BOMé™¤å»
      .trim()
      .split('\n');

    if (lines.length < 2) {
      alert('CSVã®å†…å®¹ãŒä¸æ­£ã§ã™');
      return;
    }

    const rows = lines.slice(1); // ãƒ˜ãƒƒãƒ€é™¤å¤–
    let imported = 0;

    const existingKeys = new Set(
     trades.map(t => `${t.date}_${t.time}_${t.side}_${t.amount}`)
    );

rows.forEach(line => {
  const cols = line
    .split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
    .map(v => v.replace(/^"|"$/g, ''));

  if (cols.length < 10) return;

  const trade = {
    id: 'import_' + Date.now() + '_' + Math.random().toString(36).slice(2),
    date: cols[0],
    time: cols[1],
    side: cols[2],
    entryType: cols[3] === 'æŒ‡å€¤' ? 'limit' : 'market',
    result: cols[4] === 'å‹ã¡' ? 'win' : 'lose',
    exitReason: cols[5],
    lot: Number(cols[6]),
    amount: Number(cols[7]),
    pips: Number(cols[8]),
    comment: cols[9],
    imageId: null
  };

  const key = `${trade.date}_${trade.time}_${trade.side}_${trade.amount}`;
  if (existingKeys.has(key)) return;

  trades.push(trade);
  existingKeys.add(key);
  imported++;
});

    localStorage.setItem('trades', JSON.stringify(trades));
    const skipped = rows.length - imported;
    alert(
      `ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†\n` +
      `è¿½åŠ ï¼š${imported} ä»¶\n` +
      `ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé‡è¤‡ï¼‰ï¼š${skipped} ä»¶`
    );

    fileInput.value = '';
    buildMonthSelector();  
    renderStats('all');  
  };

  reader.readAsText(file, 'utf-8');
}

/* =========================================================
   ç”»åƒè¡¨ç¤º & ä½¿ç”¨é‡
========================================================= */
function openDBImage(id) {
  if (!imgDBReady) {
    alert('ç”»åƒDBæº–å‚™ä¸­ã§ã™');
    return;
  }
  const tx = imgDB.transaction('images', 'readonly');
  const req = tx.objectStore('images').get(id);

  req.onsuccess = () => {
    if (!req.result) {
      alert('ã“ã®ç”»åƒã¯ã™ã§ã«å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    const url = URL.createObjectURL(req.result.blob);
    document.getElementById('modalImage').src = url;
    document.getElementById('imageModal').style.display = 'flex';
  };
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
  document.getElementById('modalImage').src = '';
}

// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ =====
document.getElementById('imageModal').addEventListener('click', e => {
  if (e.target.id === 'imageModal') {
    closeImageModal();
  }
});


function updateImageUsage() {
  if (!imgDBReady) return;

  if (!imgDB) return;

  let totalBytes = 0;
  const tx = imgDB.transaction('images', 'readonly');
  const store = tx.objectStore('images');

  store.openCursor().onsuccess = (e) => {
    const cursor = e.target.result;
    if (!cursor) {
      const mb = (totalBytes / 1024 / 1024).toFixed(2);
      document.getElementById('imageUsage').textContent =
        `ç”»åƒä½¿ç”¨é‡ï¼š${mb} MB`;
      return;
    }
    totalBytes += cursor.value.blob.size;
    cursor.continue();
  };
}


/* =========================================================
   æœˆæ¬¡ç”»åƒæ•´ç†
========================================================= */
function cleanupImagesForCurrentMonth() {
  if (!imgDBReady) {
    alert('ç”»åƒDBæº–å‚™ä¸­ã§ã™');
    return;
  }

  const now = new Date();
  const currentMonthStart = new Date(current.getFullYear(), current.getMonth(), 1);
  const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);

  if (currentMonthStart > thisMonthStart) {
    alert('æœªæ¥ã®æœˆã¯æ•´ç†ã§ãã¾ã›ã‚“');
    return;
  }

  const year  = current.getFullYear();
  const month = current.getMonth() + 1;

  if (!confirm(`${year}å¹´${month}æœˆã‚ˆã‚Šå‰ã®ç”»åƒã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™`)) return;

  deleteImagesBeforeMonth(year, month);
}

function deleteImagesBeforeMonth(year, month) {
  const borderTime = new Date(year, month - 1, 1).getTime();

  const tx = imgDB.transaction('images', 'readwrite');
  const store = tx.objectStore('images');

  store.openCursor().onsuccess = (e) => {
    const cursor = e.target.result;
    if (!cursor) return;

    const ts = Number(cursor.key.split('_')[1]);
    if (ts < borderTime) {
      const id = cursor.key;
      store.delete(id);
      trades.forEach((t) => {
        if (t.imageId === id) delete t.imageId;
      });
    }
    cursor.continue();
  };

  tx.oncomplete = () => {
    localStorage.setItem('trades', JSON.stringify(trades));
    updateImageUsage();
    alert(`${year}å¹´${month}æœˆã‚ˆã‚Šå‰ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
  };
}
function calcLot() {
  const margin = Number(document.getElementById('margin').value);
  const riskPercent = Number(document.getElementById('riskPercent').value);
  const stopPips = Number(document.getElementById('stopPips').value);

  if (!margin || !riskPercent || !stopPips) {
    alert('ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  const riskAmount = margin * (riskPercent / 100);

  // USDJPYï¼š1lot = 1000å†† / pips
  const lot = riskAmount / (stopPips * 1000);

  if (lot <= 0 || lot > 10) {
    alert('ãƒ­ãƒƒãƒˆãŒä¸æ­£ã§ã™ã€‚å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
    return;
  }
  
  document.getElementById('lotResult').textContent =
    `ãƒ­ãƒƒãƒˆï¼š${lot.toFixed(2)} lot`;
  lotEl.value = lot.toFixed(2);
}
function drawEquityChart(trades) {
  const canvas = document.getElementById('equityChart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!trades.length) return;

  let equity = 0;
  const sorted = [...trades].sort((a, b) =>
    (a.date + a.time).localeCompare(b.date + b.time)
  );
  const points = sorted.map(t => equity += t.amount);

  const max = Math.max(...points, 0);
  const min = Math.min(...points, 0);

  const padding = 30;
  const w = canvas.width;
  const h = canvas.height;

  /* ===== è»¸ ===== */
  ctx.strokeStyle = 'rgba(255,255,255,0.3)';
  ctx.lineWidth = 1;

  // Yè»¸
  ctx.beginPath();
  ctx.moveTo(padding, 10);
  ctx.lineTo(padding, h - padding);
  ctx.stroke();

  // Xè»¸
  ctx.beginPath();
  ctx.moveTo(padding, h - padding);
  ctx.lineTo(w - 10, h - padding);
  ctx.stroke();

  /* ===== ãƒ©ãƒ™ãƒ« ===== */
  ctx.fillStyle = '#9aa0d1';
  ctx.font = '11px system-ui';

  // Yè»¸ãƒ©ãƒ™ãƒ«
  ctx.save();
  ctx.translate(10, h / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('ç´¯ç©æç›Šï¼ˆå††ï¼‰', 0, 0);
  ctx.restore();

  // Xè»¸ãƒ©ãƒ™ãƒ«
  ctx.fillText(
    'ãƒˆãƒ¬ãƒ¼ãƒ‰å›æ•°ï¼ˆæ™‚ç³»åˆ—ï¼‰',
    w / 2 - 60,
    h - 8
  );

  /* ===== ã‚°ãƒ©ãƒ• ===== */
  ctx.beginPath();
  points.forEach((v, i) => {
    const x =
      padding +
      (i / (points.length - 1 || 1)) * (w - padding - 10);
    const y =
      (h - padding) -
      ((v - min) / (max - min || 1)) * (h - padding - 10);

    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });

  ctx.strokeStyle = '#4f7cff';
  ctx.lineWidth = 2;
  ctx.stroke();
}

  
</script>
<!-- ===============================
     Image Modal
=============================== -->
<div id="imageModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="position:relative;max-width:90%;max-height:90%;">
    <button onclick="closeImageModal()" style="
      position:absolute;
      top:-12px;
      right:-12px;
      background:#f44336;
      color:#fff;
      border:none;
      border-radius:50%;
      width:32px;
      height:32px;
      font-size:18px;
      cursor:pointer;
    ">Ã—</button>
    <img id="modalImage" style="
      max-width:100%;
      max-height:100%;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
    ">
  </div>
</div>

</body>
</html>
