<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>USDJPY Trade Journal</title>

<style>
:root{
  --bg:#0f1220;
  --card:#1b1f3b;
  --row:#20255a;
  --border:rgba(255,255,255,.12);
  --accent:#4f7cff;
  --text:#e6e8ff;
  --muted:#9aa0d1;
  --win:#4f7cff;
  --lose:#f44336;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:16px;
  text-align:center;
  font-size:20px;
  font-weight:600;
}

nav{
  display:flex;
  gap:8px;
  padding:8px;
  justify-content:center;
}

nav button{
  flex:1;
  background:linear-gradient(#22286a,#1b1f3b);
  color:var(--text);
  border:none;
  padding:10px;
  border-radius:10px;
  font-size:14px;
}
nav button.active{
  background:linear-gradient(#4f7cff,#375bd6);
  color:white;
}

main{padding:16px}

.card{
  background:linear-gradient(180deg,#1b1f3b,#14183a);
  border-radius:16px;
  padding:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}

h3{
  margin:12px 0 6px;
  font-size:14px;
  color:var(--muted);
}

/* ãƒã‚§ãƒƒã‚¯è¡Œ */
label{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 12px;
  background:var(--row);
  border-bottom:1px solid var(--border);
  font-size:14px;
  cursor:pointer;
}
label:last-of-type{border-bottom:none}
label input{width:18px;height:18px;flex-shrink:0}
label span{flex:1}

/* å…¥åŠ›å…±é€š */
input,select,textarea{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  border:none;
  background:#121533;
  color:var(--text);
}

textarea{height:60px}

/* åˆ¤å®šè¡¨ç¤º */
.result-box{
  margin:14px 0;
  padding:12px;
  text-align:center;
  border-radius:12px;
  background:rgba(255,255,255,.08);
  font-weight:600;
}
.allow{color:var(--win)}
.deny{color:var(--lose)}

button.primary{
  margin-top:8px;
  width:100%;
  padding:14px;
  background:linear-gradient(#4f7cff,#375bd6);
  border:none;
  border-radius:14px;
  color:white;
  font-size:16px;
}

/* ===== ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ² æ¨ªä¸¦ã³ ===== */
.trade-row{
  display:grid;
  grid-template-columns:1.3fr 1fr 1fr 1fr;
  gap:8px;
  margin-bottom:10px;
}
.trade-row input,
.trade-row select{
  margin-bottom:0;
}

/* å‹ã¡è² ã‘è‰² */
.result-win{color:var(--win);font-weight:600}
.result-lose{color:var(--lose);font-weight:600}

/* å£²è²·ã‚¢ã‚¤ã‚³ãƒ³ */
.side-buy::before{
  content:"â†‘ ";
  color:var(--win);
  font-weight:700;
}
.side-sell::before{
  content:"â†“ ";
  color:var(--lose);
  font-weight:700;
}

@media(max-width:600px){
  nav{flex-direction:column}
}
</style>
</head>

<body>
<header>USDJPY ãƒˆãƒ¬ãƒ¼ãƒ‰ç®¡ç†</header>

<nav>
  <button id="tab-check" class="active">ğŸ§  ãƒã‚§ãƒƒã‚¯</button>
  <button id="tab-calendar">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
  <button id="tab-stats">ğŸ“Š é›†è¨ˆ</button>
</nav>

<main>

<section id="check" class="card">

<h3>ã‚¹ãƒ†ãƒƒãƒ—â‘ ã€1æ™‚é–“è¶³ã€‘ï¼ˆå…¨ã¦YESï¼‰</h3>
<label><input type="checkbox" class="h1"><span>åˆå‹•ãŒå‡ºã¦ã„ã‚‹</span></label>
<label><input type="checkbox" class="h1"><span>åˆå‹•ã§ä¼¸ã³ãã£ã¦ã„ãªã„</span></label>
<label><input type="checkbox" class="h1"><span>MAä¹–é›¢ãŒå¤§ãã™ããªã„</span></label>
<label><input type="checkbox" class="h1"><span>é«˜å€¤ãƒ»å®‰å€¤æ´ã¿ã§ãªã„</span></label>
<label><input type="checkbox" class="h1"><span>æŠµæŠ—å¸¯ã©çœŸã‚“ä¸­ã§ãªã„</span></label>
<label><input type="checkbox" class="h1"><span>ã€Œã¾ã ä¼¸ã³ãã†ã€ã¨æ„Ÿã˜ã‚‹å½¢</span></label>

<h3>ã‚¹ãƒ†ãƒƒãƒ—â‘¡ã€4æ™‚é–“è¶³ã€‘</h3>
<label><input type="checkbox" class="h4"><span>æ˜ç¢ºãªæ–¹å‘ãŒã‚ã‚‹</span></label>
<label><input type="checkbox" class="h4"><span>é ‚ç‚¹ãƒ»åº•ä»˜è¿‘ã§ãªã„</span></label>
<label><input type="checkbox" class="h4"><span>TRçš„ã«ä½™åŠ›ã‚ã‚Š</span></label>
<label><input type="checkbox" class="h4"><span>å¼·ã„å¦å®šãƒ’ã‚²ãªã—</span></label>
<label><input type="checkbox" class="h4"><span>ãƒœãƒªãƒãƒ³å½¢çŠ¶ãŒ1Hã¨æ•´åˆ</span></label>

<h3>ã‚¹ãƒ†ãƒƒãƒ—â‘¢ã€åŸ·è¡Œè¶³åˆ¤å®šã€‘</h3>
<label><input type="radio" name="exe" value="15"><span>15åˆ†ã‚‚åˆå‹•ã§è‰¯ã„</span></label>
<label><input type="radio" name="exe" value="60"><span>15åˆ†ãŒå¾®å¦™ â†’ 1æ™‚é–“åŸ·è¡Œ</span></label>

<div id="finalResult" class="result-box">æœªåˆ¤å®š</div>

<h3>ãƒˆãƒ¬ãƒ¼ãƒ‰è¨˜éŒ²</h3>
<div class="trade-row">
  <input type="date" id="date">
  <input type="time" id="time">
  <select id="side">
    <option value="Buy">è²·ã„</option>
    <option value="Sell">å£²ã‚Š</option>
  </select>
  <select id="result">
    <option value="win">å‹ã¡</option>
    <option value="lose">è² ã‘</option>
  </select>
</div>

<input type="number" id="lot" placeholder="ãƒ­ãƒƒãƒˆæ•°">
<input type="number" id="amount" placeholder="æç›Šï¼ˆå††ï¼‰">
<input type="number" id="pips" placeholder="pipsï¼ˆè‡ªå‹•ï¼‰" disabled>
<textarea id="comment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
<input type="file" id="tradeImage" accept="image/*">
<img id="previewImage" style="display:none;max-width:100%;border-radius:8px;margin-bottom:10px">

  
<button class="primary" onclick="saveTrade()">ä¿å­˜</button>
</section>

<section id="calendar" class="card" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <button onclick="changeMonth(-1)">â†</button>
    <div id="currentMonth"></div>
    <button onclick="changeMonth(1)">â†’</button>
  </div>
  <div id="monthTotal" style="margin-bottom:10px;font-weight:600"></div>
  <div id="calendarGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>
  <div id="dayDetail" style="margin-top:14px"></div>
</section>

<section id="stats" class="card" style="display:none">
  <div id="statsContent"></div>
</section>

</main>

<script>
const trades=JSON.parse(localStorage.getItem('trades')||'[]');

const date=document.getElementById('date');
const time=document.getElementById('time');
const side=document.getElementById('side');
const result=document.getElementById('result');
const lotEl=document.getElementById('lot');
const amountEl=document.getElementById('amount');
const pipsEl=document.getElementById('pips');
const comment=document.getElementById('comment');
const tradeImage = document.getElementById('tradeImage');
const previewImage = document.getElementById('previewImage');
  
document.querySelectorAll('input').forEach(i=>i.onchange=judge);

let imageData = null;

tradeImage.addEventListener('change',()=>{
  const file = tradeImage.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = e=>{
    imageData = e.target.result;
    previewImage.src = imageData;
    previewImage.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

  
function judge(){
  const h1=[...document.querySelectorAll('.h1')].every(c=>c.checked);
  const h4=[...document.querySelectorAll('.h4')].every(c=>c.checked);
  const exe=document.querySelector('input[name="exe"]:checked');
  const box=document.getElementById('finalResult');

  if(!h1){ box.textContent='âŒ è¦‹é€ã‚Šï¼š1æ™‚é–“è¶³æ¡ä»¶æœªé”'; box.className='result-box deny'; return; }
  if(!h4){ box.textContent='âŒ è¦‹é€ã‚Šï¼š4æ™‚é–“è¶³ãŒå¦å®š'; box.className='result-box deny'; return; }
  if(!exe){ box.textContent='âš  åŸ·è¡Œè¶³æœªé¸æŠ'; return; }

  box.textContent=`âœ… ã‚¨ãƒ³ãƒˆãƒªãƒ¼å¯ï½œåŸ·è¡Œè¶³ï¼š${exe.value}åˆ†`;
  box.className='result-box allow';
}

function saveTrade(){
    if(!date.value){
    alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  const lot = Number(lotEl.value);
  const amt = Number(amountEl.value);
  const pips = amt / (lot * 1000);
  pipsEl.value = pips.toFixed(1);

  trades.push({
    date: date.value,
    time: time.value,
    side: side.value,
    result: result.value,
    lot,
    amount: amt,
    pips,
    comment: comment.value,
    image: imageData
  });

  localStorage.setItem('trades', JSON.stringify(trades));

  // â˜… ã“ã‚Œã‚‰ã¯ã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¤–ã€ã§å®Ÿè¡Œã™ã‚‹
  tradeImage.value = '';
  previewImage.style.display = 'none';
  imageData = null;

  alert('ä¿å­˜ã—ã¾ã—ãŸ');
}

let current=new Date();
function changeMonth(diff){
  current.setMonth(current.getMonth()+diff);
  renderCalendar();
}
function renderCalendar(){
  const y=current.getFullYear();
  const m=current.getMonth();
  document.getElementById('currentMonth').textContent=`${y}å¹´ ${m+1}æœˆ`;
  const grid=document.getElementById('calendarGrid');
  grid.innerHTML='';
  let monthSum=0;

  const days=new Date(y,m+1,0).getDate();
  for(let d=1;d<=days;d++){
    const dateStr=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayTrades=trades.filter(t=>t.date===dateStr);
    const total=dayTrades.reduce((a,b)=>a+b.amount,0);
    monthSum+=total;

    const cell=document.createElement('div');
    cell.style.padding='6px';
    cell.style.borderRadius='8px';
    cell.style.background='rgba(255,255,255,.05)';
    cell.style.cursor='pointer';
    cell.innerHTML=`<div>${d}</div><div style="font-size:12px">${total||''}</div>`;
    cell.onclick=()=>showDayDetail(dateStr);
    grid.appendChild(cell);
  }
  document.getElementById('monthTotal').textContent=`æœˆåˆè¨ˆï¼š${monthSum.toLocaleString()} å††`;
}

function showDayDetail(date){
  const box=document.getElementById('dayDetail');
  const list=trades.filter(t=>t.date===date);
  if(!list.length){ box.innerHTML=''; return; }

  box.innerHTML=`<h4>${date} å†…è¨³</h4>`+
    list.map((t,i)=>`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span>${t.time} ${t.side} ${t.amount}</span>
ã€€ã€€ã€€ã€€ã€€${t.image ? `
  <img src="${t.image}"
       style="width:100px;border-radius:6px;cursor:pointer"
       onclick="openImage(this.src)">
` : ''}


        <button onclick="deleteTrade(${i},'${date}')">å‰Šé™¤</button>
      </div>
    `).join('');
}

function deleteTrade(idx,date){
  const i=trades.findIndex((t,n)=>t.date===date && n>=idx);
  trades.splice(i,1);
  localStorage.setItem('trades',JSON.stringify(trades));
  renderCalendar();
  showDayDetail(date);
}
/* ===== è¦‹ãŸç›®è‡ªå‹•åæ˜  ===== */
function updateTradeVisual(){
  side.classList.remove('side-buy','side-sell');
  result.classList.remove('result-win','result-lose');

  if(side.value==='Buy') side.classList.add('side-buy');
  if(side.value==='Sell') side.classList.add('side-sell');
  if(result.value==='win') result.classList.add('result-win');
  if(result.value==='lose') result.classList.add('result-lose');
}

updateTradeVisual();
side.addEventListener('change',updateTradeVisual);
result.addEventListener('change',updateTradeVisual);

/* ===== ã‚¿ãƒ– ===== */
function switchTab(tabId){
  ['check','calendar','stats'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
  document.getElementById(tabId).style.display='block';

  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  const map={check:'tab-check',calendar:'tab-calendar',stats:'tab-stats'};
  document.getElementById(map[tabId]).classList.add('active');

  if(tabId==='calendar') renderCalendar();
  if(tabId==='stats') renderStats();
}


document.getElementById('tab-check').onclick=()=>switchTab('check');
document.getElementById('tab-calendar').onclick=()=>switchTab('calendar');
document.getElementById('tab-stats').onclick=()=>switchTab('stats');

function renderStats(){
  const box = document.getElementById('statsContent');
  if(!trades.length){
    box.innerHTML = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
    return;
  }

  // æœˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
  const monthly = {};
  trades.forEach(t=>{
  if(!t.date || t.date.length < 7) return; // â˜… ä¸æ­£ãƒ‡ãƒ¼ã‚¿é™¤å¤–

  const key = t.date.slice(0,7); // YYYY-MM
  if(!monthly[key]) monthly[key] = [];
  monthly[key].push(t);
});

  box.innerHTML = Object.entries(monthly).map(([month,list])=>{
    const wins = list.filter(t=>t.amount>0);
    const loses = list.filter(t=>t.amount<0);

    const winCount = wins.length;
    const loseCount = loses.length;
    const total = list.length;

    const winRate = total ? (winCount/total*100).toFixed(1) : 0;

    const totalWin = wins.reduce((a,b)=>a+b.amount,0);
    const totalLose = Math.abs(loses.reduce((a,b)=>a+b.amount,0));

    const avgWin = winCount ? totalWin/winCount : 0;
    const avgLose = loseCount ? totalLose/loseCount : 0;

    const rr = avgLose ? (avgWin/avgLose).toFixed(2) : '-';
    const pf = totalLose ? (totalWin/totalLose).toFixed(2) : '-';

    // æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³
    let peak = 0;
    let equity = 0;
    let maxDD = 0;
    list.forEach(t=>{
      equity += t.amount;
      if(equity > peak) peak = equity;
      maxDD = Math.min(maxDD, equity - peak);
    });

    return `
      <div style="margin-bottom:14px;padding:12px;border-radius:12px;background:rgba(255,255,255,.06)">
        <strong>${month}</strong><br>
        å‹ç‡ï¼š${winRate}%<br>
        å‹æ•—æ•°ï¼š${winCount}å‹ / ${loseCount}æ•—<br>
        RRï¼š${rr}<br>
        PFï¼š${pf}<br>
        æœ€å¤§DDï¼š${maxDD.toLocaleString()} å††
      </div>
    `;
  }).join('');
}

function openImage(src){
  const w = window.open();
  w.document.write(`<img src="${src}" style="max-width:100%">`);
}

</script>

</body>
</html>
