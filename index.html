<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trade OS</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f2f2f7;
  color: #111;
}
header {
  background: #0a0a0a;
  color: #fff;
  padding: 14px;
  text-align: center;
  font-weight: 600;
}
.tabs {
  display: flex;
  background: #fff;
  border-bottom: 1px solid #ddd;
}
.tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  font-weight: 600;
  color: #777;
}
.tab.active {
  color: #111;
  border-bottom: 3px solid #007aff;
}
.container {
  padding: 16px;
}
.section { display: none; }
.section.active { display: block; }

.card {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 16px;
}

h2 {
  font-size: 17px;
  margin-bottom: 10px;
}
label {
  display: block;
  margin: 6px 0;
}
button {
  width: 100%;
  padding: 12px;
  background: #007aff;
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  margin-top: 10px;
}
.result {
  margin-top: 10px;
  font-weight: bold;
}
.calendar {
  display: grid;
  grid-template-columns: repeat(7,1fr);
  gap: 4px;
}
.day {
  background: #fff;
  border-radius: 8px;
  padding: 6px;
  font-size: 12px;
  cursor: pointer;
}
.day .pnl {
  font-weight: bold;
  margin-top: 4px;
}
.positive { color: #0a8a3a; }
.negative { color: #d00; }
.log-item {
  background: #fff;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
  font-size: 13px;
}
.small { font-size: 12px; color: #666; }
</style>
</head>

<body>

<header>Trade OS</header>

<div class="tabs">
  <div class="tab active" onclick="switchTab('check')">チェック</div>
  <div class="tab" onclick="switchTab('calendar')">カレンダー</div>
  <div class="tab" onclick="switchTab('stats')">集計</div>
</div>

<div class="container">

<!-- チェック -->
<div id="check" class="section active">

<div class="card">
<h2>4時間足</h2>
<label><input type="checkbox" class="chk h4"> 明確なトレンド</label>
<label><input type="checkbox" class="chk h4"> 波の途中</label>
<label><input type="checkbox" class="chk h4"> ヒゲ否定なし</label>
</div>

<div class="card">
<h2>1時間足</h2>
<label><input type="checkbox" class="chk h1"> 初動</label>
<label><input type="checkbox" class="chk h1"> MA乖離なし</label>
<label><input type="checkbox" class="chk h1"> 抵抗帯クリア</label>
</div>

<div class="card">
<h2>執行足（15分）</h2>
<label><input type="checkbox" class="chk m15"> 押し目 / 戻り</label>
<label><input type="checkbox" class="chk m15"> 直近高安更新</label>
<label><input type="checkbox" class="chk m15"> 勢い継続</label>
</div>

<div class="card">
<h2>判定</h2>
<div id="decision" class="result">未判定</div>
</div>

<div class="card">
<h2>記録</h2>
<label>ロット <input id="lot" type="number" step="0.01"></label>
<label>金額（円） <input id="amount" type="number"></label>
<button onclick="saveTrade()">記録する</button>
</div>

</div>

<!-- カレンダー -->
<div id="calendar" class="section">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;">
<button onclick="changeMonth(-1)">←</button>
<div id="monthLabel"></div>
<button onclick="changeMonth(1)">→</button>
</div>
<div class="calendar" id="calendarGrid"></div>
</div>

<div class="card">
<h2 id="selectedDate"></h2>
<div id="dayLogs"></div>
</div>
</div>

<!-- 集計 -->
<div id="stats" class="section">
<div class="card" id="statsBox"></div>
</div>

</div>

<script>
let currentMonth = new Date();

function switchTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelector(`[onclick="switchTab('${id}')"]`).classList.add('active');
}

function evaluate(){
  const h4 = document.querySelectorAll('.h4:checked').length;
  const h1 = document.querySelectorAll('.h1:checked').length;
  const m15 = document.querySelectorAll('.m15:checked').length;
  const el = document.getElementById('decision');

  if(h4>=2 && h1>=2 && m15>=2){
    el.textContent = "エントリーOK（15分足）";
    el.style.color = "#0a8a3a";
    return true;
  } else {
    el.textContent = "見送り";
    el.style.color = "#d00";
    return false;
  }
}
document.querySelectorAll('.chk').forEach(c=>c.addEventListener('change',evaluate));

function saveTrade(){
  if(!evaluate()) return alert("条件未達");

  const lot = +lotInput.value;
  const amount = +amountInput.value;
  const pips = amount / (lot * 1000);

  const trade = {
    datetime: new Date().toISOString(),
    lot, amount, pips
  };
  const data = JSON.parse(localStorage.getItem('trades')||'[]');
  data.push(trade);
  localStorage.setItem('trades',JSON.stringify(data));
  alert("保存しました");
  renderCalendar();
  renderStats();
}

function renderCalendar(){
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML='';
  const trades = JSON.parse(localStorage.getItem('trades')||'[]');
  const y = currentMonth.getFullYear();
  const m = currentMonth.getMonth();
  document.getElementById('monthLabel').textContent = `${y}/${m+1}`;

  for(let d=1;d<=31;d++){
    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayTrades = trades.filter(t=>t.datetime.startsWith(dateStr));
    if(dayTrades.length===0 && d>28) continue;

    const pnl = dayTrades.reduce((s,t)=>s+t.amount,0);
    const div = document.createElement('div');
    div.className='day';
    div.innerHTML = `${d}<div class="pnl ${pnl>=0?'positive':'negative'}">${pnl||''}</div>`;
    div.onclick=()=>showDay(dateStr,dayTrades);
    grid.appendChild(div);
  }
}

function showDay(date,trades){
  document.getElementById('selectedDate').textContent=date;
  const box=document.getElementById('dayLogs');
  box.innerHTML='';
  trades.forEach((t,i)=>{
    const d=document.createElement('div');
    d.className='log-item';
    d.innerHTML=`${new Date(t.datetime).toLocaleTimeString()} / ${t.pips.toFixed(1)} pips / ¥${t.amount}
    <button onclick="deleteTrade('${t.datetime}')">削除</button>`;
    box.appendChild(d);
  });
}

function deleteTrade(dt){
  let data=JSON.parse(localStorage.getItem('trades'));
  data=data.filter(t=>t.datetime!==dt);
  localStorage.setItem('trades',JSON.stringify(data));
  renderCalendar();
  renderStats();
}

function renderStats(){
  const trades=JSON.parse(localStorage.getItem('trades')||'[]');
  const win=trades.filter(t=>t.amount>0);
  const rate=trades.length? (win.length/trades.length*100).toFixed(1):0;
  const avgPips=trades.length?(trades.reduce((s,t)=>s+t.pips,0)/trades.length).toFixed(1):0;
  const sum=trades.reduce((s,t)=>s+t.amount,0);

  statsBox.innerHTML=`
  勝率：${rate}%<br>
  平均pips：${avgPips}<br>
  合計損益：¥${sum}
  `;
}

renderCalendar();
renderStats();
</script>

</body>
</html>
